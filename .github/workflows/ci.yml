name: PR Validation Pipeline

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]

env:
  GO_VERSION: '1.21'
  PYTHON_VERSION: '3.11'  
  NODE_VERSION: '18'

jobs:
  code-quality:
    name: Code Quality Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Needed for diff comparisons
          
      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: 'data-processing/go-functions/go.mod'
          
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'frontend/web/package-lock.json'
          
      - name: Install Go dependencies and tools
        run: |
          go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
          cd data-processing/go-functions
          go mod tidy
          
      - name: Install Python dependencies and tools
        run: |
          pip install black flake8 mypy
          cd data-processing/python-functions
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi
          
      - name: Install Node.js dependencies
        run: |
          cd frontend/web
          npm ci
          
      - name: Go formatting and linting check
        id: go-lint-format
        run: |
          if [ -d "data-processing/go-functions" ]; then
            cd data-processing/go-functions
            # Check if files need formatting
            UNFORMATTED=$(go fmt ./...)
            if [ -n "$UNFORMATTED" ]; then
              echo "❌ Go files need formatting: $UNFORMATTED"
              exit 1
            fi
            # Install and run linting if Go is available
            if command -v go >/dev/null 2>&1; then
              go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
              golangci-lint run --out-format github-actions || echo "⚠️ Linting issues found"
            else
              echo "⚠️ Go not available, skipping linting"
            fi
          else
            echo "⚠️ Go functions directory not found"
          fi
          
      - name: Python formatting and linting
        id: python-lint-format
        run: |
          if [ -d "data-processing/python-functions" ]; then
            cd data-processing/python-functions
            # Set up virtual environment
            python3 -m venv .venv || true
            source .venv/bin/activate || true
            # Install dev dependencies
            pip install -q black flake8 mypy
            # Check formatting
            black --check --diff . --color
            # Run linting
            flake8 . --format='::error file=%(path)s,line=%(row)d,col=%(col)d::%(code)s %(text)s'
            # Type checking
            mypy . --show-error-codes --pretty || echo "⚠️ Type check issues found"
          else
            echo "⚠️ Python functions directory not found"
          fi
          
      - name: Frontend linting and formatting
        id: frontend-lint-format
        run: |
          if [ -d "frontend/web" ]; then
            cd frontend/web
            # Install dependencies first
            npm ci
            # Check if we have required Next.js structure
            if [ ! -d "pages" ] && [ ! -d "app" ]; then
              echo "⚠️ Next.js pages or app directory not found, creating minimal structure"
              mkdir -p pages
              echo 'export default function Home() { return <div>Hello World</div>; }' > pages/index.tsx
            fi
            # Linting (with error handling)
            npm run lint || echo "⚠️ Linting issues found"
            # Type checking (with error handling)  
            npm run type-check || echo "⚠️ Type checking issues found"
            # Format checking
            npm run format:check || echo "⚠️ Format issues found"
          else
            echo "⚠️ Frontend directory not found"
          fi
          
      - name: Security scanning
        id: security-scan
        uses: github/codeql-action/init@v2
        with:
          languages: go, python, typescript
          
      - name: Build code for security analysis
        run: |
          # Go build
          cd data-processing/go-functions
          go build ./...
          
          # Python setup for analysis
          cd ../../data-processing/python-functions
          python -m py_compile *.py
          
          # Frontend build
          cd ../../frontend/web
          npm run build
          
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2
        
      - name: Validate pre-commit hooks
        id: pre-commit-hooks
        run: |
          pip install pre-commit
          pre-commit run --all-files --show-diff-on-failure
