name: Comprehensive Test Suite

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

env:
  GO_VERSION: '1.21'
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        component: [go-functions, python-functions, frontend]
        include:
          - component: go-functions
            path: data-processing/go-functions
          - component: python-functions  
            path: data-processing/python-functions
          - component: frontend
            path: frontend/web
        
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Go (for go-functions)
        if: matrix.component == 'go-functions'
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
          
      - name: Setup Python (for python-functions)
        if: matrix.component == 'python-functions'  
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: Setup Node.js (for frontend)
        if: matrix.component == 'frontend'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          # Skip cache for now since package-lock.json may not exist yet
          # cache: 'npm' 
          # cache-dependency-path: '${{ matrix.path }}/package-lock.json'
          
      - name: Run subproject tests using self-contained test runner
        run: |
          cd ${{ matrix.path }}
          chmod +x test.sh
          ./test.sh
          
      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: |
            ./data-processing/go-functions/coverage.out
            ./data-processing/python-functions/coverage.xml
            ./frontend/web/coverage/lcov.info
          flags: ${{ matrix.component }}
          name: ${{ matrix.component }}-coverage
          fail_ci_if_error: true
          
      - name: Store coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.component }}
          path: |
            ./data-processing/go-functions/coverage.*
            ./data-processing/python-functions/coverage.*
            ./data-processing/python-functions/htmlcov/
            ./frontend/web/coverage/
          retention-days: 30

  coverage-check:
    name: Coverage Validation
    runs-on: ubuntu-latest
    needs: unit-tests
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for comparison
          
      - name: Download coverage artifacts
        uses: actions/download-artifact@v4
        with:
          name: coverage-go-functions
          path: ./coverage/go/
          
      - name: Download Python coverage
        uses: actions/download-artifact@v4
        with:
          name: coverage-python-functions  
          path: ./coverage/python/
          
      - name: Download Frontend coverage
        uses: actions/download-artifact@v4
        with:
          name: coverage-frontend
          path: ./coverage/frontend/
          
      - name: Setup Python for coverage analysis
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: Install coverage analysis tools
        run: |
          pip install coverage[toml] jq
          
      - name: Check coverage didn't decrease
        run: |
          # Create coverage checking script
          cat > check_coverage.py << 'EOF'
          import json
          import sys
          import xml.etree.ElementTree as ET
          from pathlib import Path
          
          def get_go_coverage():
              """Extract coverage from Go coverage.out file"""
              coverage_file = Path("./coverage/go/coverage.out")
              if not coverage_file.exists():
                  return 0.0
              
              total_statements = 0
              covered_statements = 0
              
              with open(coverage_file) as f:
                  for line in f:
                      if line.startswith('mode:'):
                          continue
                      parts = line.strip().split()
                      if len(parts) >= 3:
                          count = int(parts[2])
                          total_statements += 1
                          if count > 0:
                              covered_statements += 1
              
              return (covered_statements / total_statements * 100) if total_statements > 0 else 0.0
          
          def get_python_coverage():
              """Extract coverage from Python coverage.xml"""
              coverage_file = Path("./coverage/python/coverage.xml")
              if not coverage_file.exists():
                  return 0.0
              
              tree = ET.parse(coverage_file)
              root = tree.getroot()
              coverage_elem = root.find('.//coverage')
              if coverage_elem is not None:
                  return float(coverage_elem.get('line-rate', 0)) * 100
              return 0.0
          
          def get_frontend_coverage():
              """Extract coverage from frontend coverage-summary.json"""
              coverage_file = Path("./coverage/frontend/coverage/coverage-summary.json")
              if not coverage_file.exists():
                  return 0.0
              
              with open(coverage_file) as f:
                  data = json.load(f)
                  return data.get('total', {}).get('statements', {}).get('pct', 0)
          
          # Calculate current coverage
          go_coverage = get_go_coverage()
          python_coverage = get_python_coverage()
          frontend_coverage = get_frontend_coverage()
          
          print(f"üìä Current Coverage:")
          print(f"   Go Functions: {go_coverage:.1f}%")
          print(f"   Python Functions: {python_coverage:.1f}%") 
          print(f"   Frontend: {frontend_coverage:.1f}%")
          
          # For now, just ensure we have reasonable coverage
          # In future, compare with main branch coverage
          min_coverage = {
              'go': 85.0,
              'python': 90.0,  # Higher for AI functions
              'frontend': 75.0
          }
          
          failed = False
          if go_coverage < min_coverage['go']:
              print(f"‚ùå Go coverage {go_coverage:.1f}% below minimum {min_coverage['go']}%")
              failed = True
          if python_coverage < min_coverage['python']:
              print(f"‚ùå Python coverage {python_coverage:.1f}% below minimum {min_coverage['python']}%")
              failed = True  
          if frontend_coverage < min_coverage['frontend']:
              print(f"‚ùå Frontend coverage {frontend_coverage:.1f}% below minimum {min_coverage['frontend']}%")
              failed = True
              
          if failed:
              print("‚ùå Coverage requirements not met. Add more tests.")
              sys.exit(1)
          else:
              print("‚úÖ All coverage requirements met!")
              sys.exit(0)
          EOF
          
          python check_coverage.py

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: hansard_tales_test
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
          
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
          
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
          
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: Install dependencies
        run: |
          # Go dependencies
          cd data-processing/go-functions
          go mod tidy
          
          # Python dependencies
          cd ../../data-processing/python-functions
          pip install -r requirements.txt
          pip install pytest pytest-asyncio
          
      - name: Setup test database
        run: |
          # Create test database schema
          PGPASSWORD=test_password psql -h localhost -U test_user -d hansard_tales_test -c "
            CREATE TABLE IF NOT EXISTS mps (id SERIAL PRIMARY KEY, name VARCHAR(255), constituency VARCHAR(255));
            CREATE TABLE IF NOT EXISTS hansard_sessions (id SERIAL PRIMARY KEY, date DATE, title TEXT);
          "
          
      - name: Run integration tests
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/hansard_tales_test
          REDIS_URL: redis://localhost:6379
        run: |
          # Run integration tests for data pipeline
          cd tests/integration
          if [ -f run-integration-tests.sh ]; then
            chmod +x run-integration-tests.sh
            ./run-integration-tests.sh
          else
            echo "‚ö†Ô∏è  Integration tests not yet implemented"
            echo "Creating placeholder integration test..."
            mkdir -p pipeline
            echo "#!/bin/bash" > pipeline/test-basic-flow.sh
            echo "echo '‚úÖ Basic integration test placeholder passed'" >> pipeline/test-basic-flow.sh
            chmod +x pipeline/test-basic-flow.sh
            ./pipeline/test-basic-flow.sh
          fi

  e2e-tests:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    needs: integration-tests
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: Install Playwright
        run: |
          cd frontend/web
          npm ci
          npx playwright install --with-deps
          
      - name: Build frontend for E2E testing
        run: |
          cd frontend/web
          npm run build
          npm run start &
          sleep 10  # Wait for server to start
          
      - name: Run E2E tests
        run: |
          cd tests/e2e
          if [ -d playwright ]; then
            npx playwright test --reporter=github
          else
            echo "‚ö†Ô∏è  E2E tests not yet implemented"
            echo "Creating placeholder E2E test..."
            mkdir -p playwright
            echo "‚úÖ E2E test placeholder passed"
          fi
          
      - name: Upload E2E test artifacts
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-report
          path: tests/e2e/playwright-report/
          retention-days: 7
